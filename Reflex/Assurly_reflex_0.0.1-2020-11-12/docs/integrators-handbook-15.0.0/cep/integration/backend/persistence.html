<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia Site Renderer 1.9.2 at 2020-09-25 
 | Rendered using Apache Maven Fluido Skin 1.5
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="Date-Revision-yyyymmdd" content="20200925" />
    <meta http-equiv="Content-Language" content="en" />
    <title>ReFlex ReFlex Integrator's Handbook &#x2013; CEP back end persistence configuration</title>
    <link rel="stylesheet" href="../../../css/apache-maven-fluido-1.5.min.css" />
    <link rel="stylesheet" href="../../../css/site.css" />
    <link rel="stylesheet" href="../../../css/print.css" media="print" />

      
    <script type="text/javascript" src="../../../js/apache-maven-fluido-1.5.min.js"></script>

                      </head>
        <body class="topBarDisabled">
          
        
    
        <div class="container-fluid">
          <div id="banner">
        <div class="pull-left">
                                    <a href="https://www.hannover-re.com/" id="bannerLeft">
                                                                                                <img src="../../../images/logo.svg"  alt="HannoverRe"/>
                </a>
                      </div>
        <div class="pull-right">                  <a href="https://www.hannover-re.com/" id="bannerRight">
                                                                                                <img src="../../../images/hre-logo.svg"  alt="HannoverRe_log"/>
                </a>
      </div>
        <div class="clear"><hr/></div>
      </div>

      <div id="breadcrumbs">
        <ul class="breadcrumb">
              
                  <li id="projectVersion">Version: 15.0.0
                    </li>
              
              
                  <li id="publishDate" class="pull-right">Last Published: 2020-09-25</li>
            
                            </ul>
      </div>

            
      <div class="row-fluid">
        <div id="leftColumn" class="span2">
          <div class="well sidebar-nav">
              
                <ul class="nav nav-list">
                          
      <li>
  
                          <a href="../../../index.html" title="Document Information">
          <span class="none"></span>
        Document Information</a>
            </li>
                                                                                                                                                            
      <li>
  
                          <a href="../../../reflex-overview/index.html" title="ReFlex Overview">
          <span class="icon-chevron-right"></span>
        ReFlex Overview</a>
                  </li>
                
      <li>
  
                          <a href="../../../installation-guide.html" title="Installation Guide">
          <span class="none"></span>
        Installation Guide</a>
            </li>
                                                                                                      
      <li>
  
                          <a href="../../../update-guide/index.html" title="Update Guide">
          <span class="icon-chevron-right"></span>
        Update Guide</a>
                  </li>
                                                                                                                        
      <li>
  
                          <a href="../../../use-cases/index.html" title="Use Cases">
          <span class="icon-chevron-right"></span>
        Use Cases</a>
                  </li>
                              <li class="nav-header">RAS documentation</li>
                              
      <li>
  
                          <a href="../../../ras/overview.html" title="Overview">
          <span class="none"></span>
        Overview</a>
            </li>
                                                                                                      
      <li>
  
                          <a href="../../../ras/configuration.html" title="Configuration">
          <span class="icon-chevron-right"></span>
        Configuration</a>
                  </li>
                                                                                                      
      <li>
  
                          <a href="../../../ras/general-notes/index.html" title="General Notes">
          <span class="icon-chevron-right"></span>
        General Notes</a>
                  </li>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
      <li>
  
                          <a href="../../../ras/rest-resources/index.html" title="REST API">
          <span class="icon-chevron-right"></span>
        REST API</a>
                  </li>
                                                                                                                                                                                                                                                      
      <li>
  
                          <a href="../../../ras/usage-scenarios/index.html" title="Usage Scenarios">
          <span class="icon-chevron-right"></span>
        Usage Scenarios</a>
                  </li>
                                                                                                                                          
      <li>
  
                          <a href="../../../ras/known-issues/index.html" title="Known Issues">
          <span class="icon-chevron-right"></span>
        Known Issues</a>
                  </li>
                              <li class="nav-header">CEP documentation</li>
                              
      <li>
  
                          <a href="../../../cep/integration/integration_mechanism.html" title="Integration Mechanism">
          <span class="none"></span>
        Integration Mechanism</a>
            </li>
                                                                                                                                                                                                    
      <li>
  
                          <a href="../../../cep/integration/backend/index.html" title="Back End Integration">
          <span class="icon-chevron-down"></span>
        Back End Integration</a>
                    <ul class="nav nav-list">
                                                                                        
      <li>
  
                          <a href="../../../cep/integration/backend/configuration/index.html" title="Configuration">
          <span class="icon-chevron-right"></span>
        Configuration</a>
                  </li>
                    
      <li class="active">
  
            <a href="#"><span class="none"></span>Persistence</a>
          </li>
                                                                                        
      <li>
  
                          <a href="../../../cep/integration/backend/rest_api/index.html" title="REST API">
          <span class="icon-chevron-right"></span>
        REST API</a>
                  </li>
              </ul>
        </li>
                                                                                                                                                                                                                        
      <li>
  
                          <a href="../../../cep/integration/frontend/index.html" title="Front End Integration">
          <span class="icon-chevron-right"></span>
        Front End Integration</a>
                  </li>
                                                                                    
      <li>
  
                          <a href="../../../cep/integration/features/index.html" title="Optional Features">
          <span class="icon-chevron-right"></span>
        Optional Features</a>
                  </li>
                                                                                                                              
      <li>
  
                          <a href="../../../cep/integration/operations/index.html" title="Operations">
          <span class="icon-chevron-right"></span>
        Operations</a>
                  </li>
                
      <li>
  
                          <a href="../../../cep/integration/known_issues.html" title="Known Issues">
          <span class="none"></span>
        Known Issues</a>
            </li>
                              <li class="nav-header">DCS documentation</li>
                              
      <li>
  
                          <a href="../../../dcs/index.html" title="Overview">
          <span class="none"></span>
        Overview</a>
            </li>
                
      <li>
  
                          <a href="../../../dcs/configuration.html" title="Configuration">
          <span class="none"></span>
        Configuration</a>
            </li>
                
      <li>
  
                          <a href="../../../dcs/rest-api.html" title="REST API">
          <span class="none"></span>
        REST API</a>
            </li>
                                                                                                      
      <li>
  
                          <a href="../../../dcs/template-config/template-configuration.html" title="Template Configuration">
          <span class="icon-chevron-right"></span>
        Template Configuration</a>
                  </li>
                
      <li>
  
                          <a href="../../../dcs/known-issues.html" title="Known Issues">
          <span class="none"></span>
        Known Issues</a>
            </li>
                              <li class="nav-header">RSP documentation</li>
                                                                                                                                                        
      <li>
  
                          <a href="../../../rsp/integration/integration.html" title="Integration">
          <span class="icon-chevron-right"></span>
        Integration</a>
                  </li>
                                                                                                                                                                                    
      <li>
  
                          <a href="../../../rsp/configuration/configuration.html" title="Configuration">
          <span class="icon-chevron-right"></span>
        Configuration</a>
                  </li>
                              <li class="nav-header">MI documentation</li>
                              
      <li>
  
                          <a href="../../../mi/installation/app-queue.html" title="AppQueue Installation">
          <span class="none"></span>
        AppQueue Installation</a>
            </li>
                                                                                    
      <li>
  
                          <a href="../../../mi/index.html" title="Data export">
          <span class="icon-chevron-right"></span>
        Data export</a>
                  </li>
                              <li class="nav-header">3PS documentation</li>
                              
      <li>
  
                          <a href="../../../tps/overview.html" title="Overview">
          <span class="none"></span>
        Overview</a>
            </li>
                                                                                                                        
      <li>
  
                          <a href="../../../tps/configuration.html" title="Configuration">
          <span class="icon-chevron-right"></span>
        Configuration</a>
                  </li>
                                                                                    
      <li>
  
                          <a href="../../../tps/api.html" title="REST API">
          <span class="icon-chevron-right"></span>
        REST API</a>
                  </li>
                              <li class="nav-header">UWB documentation</li>
                              
      <li>
  
                          <a href="../../../uwb/index.html" title="Overview">
          <span class="none"></span>
        Overview</a>
            </li>
                                                                  
      <li>
  
                          <a href="../../../uwb/installation/index.html" title="Installation">
          <span class="icon-chevron-right"></span>
        Installation</a>
                  </li>
                                                                                                                        
      <li>
  
                          <a href="../../../uwb/configuration/application/index.html" title="Application Configuration">
          <span class="icon-chevron-right"></span>
        Application Configuration</a>
                  </li>
                                                                                                                                                                                    
      <li>
  
                          <a href="../../../uwb/configuration/office/index.html" title="Office Configuration">
          <span class="icon-chevron-right"></span>
        Office Configuration</a>
                  </li>
                                                                                                                                                                                    
      <li>
  
                          <a href="../../../uwb/features/index.html" title="Advanced Features">
          <span class="icon-chevron-right"></span>
        Advanced Features</a>
                  </li>
                                                                  
      <li>
  
                          <a href="../../../uwb/operations/index.html" title="Operations">
          <span class="icon-chevron-right"></span>
        Operations</a>
                  </li>
                
      <li>
  
                          <a href="../../../uwb/known_issues.html" title="Known Issues">
          <span class="none"></span>
        Known Issues</a>
            </li>
                              <li class="nav-header">MIGRATION documentation</li>
                              
      <li>
  
                          <a href="../../../migration/index.html" title="User Guide">
          <span class="none"></span>
        User Guide</a>
            </li>
                              <li class="nav-header">Appendix</li>
                              
      <li>
  
                          <a href="../../../glossary.html" title="Glossary">
          <span class="none"></span>
        Glossary</a>
            </li>
                
      <li>
  
                          <a href="../../../component-versions.html" title="Component Versions">
          <span class="none"></span>
        Component Versions</a>
            </li>
                                                                                                                                          
      <li>
  
                          <a href="../../../release-migration-notes.html" title="Release And Migration Notes">
          <span class="icon-chevron-right"></span>
        Release And Migration Notes</a>
                  </li>
                
      <li>
  
                          <a href="../../../changelog.html" title="Changelog">
          <span class="none"></span>
        Changelog</a>
            </li>
            </ul>
              
                
          <hr />

           <div id="poweredBy">
                            <div class="clear"></div>
                            <div class="clear"></div>
                            <div class="clear"></div>
                            <div class="clear"></div>
                             <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy">
        <img class="builtBy" alt="Built by Maven" src="../../../images/logos/maven-feather.png" />
      </a>
                  </div>
          </div>
        </div>
        
                
        <div id="bodyColumn"  class="span10" >
                                  
            <h1>CEP back end persistence configuration</h1>
<p>CEP services require a persistent storage mechanism, ex.:</p>
<ul>

<li>Active applications</li>
<li>Suspended application form persistence</li>
</ul>
<blockquote>

<p>NOTE: The data stored by the CEP services is <b>UTF-8 encoded</b> (JSON), therefore please make sure that your database supports this encoding.</p>
</blockquote>
<p>The storage mechanism for applications supports a wide range of data sources. CEP uses <a class="externalLink" href="https://projects.spring.io/spring-data/">spring-data</a> as storage abstraction layer which provides a variety of different implementations like spring-data-jpa, spring-data-mongodb, spring-data-keyvalue and other. CEP ships with <a class="externalLink" href="https://hazelcast.org/">hazelcast</a> (a non-persistent storage provider) as default implementation but also supports spring-data-jpa.</p>
<p>Currently CEP requires the following logical storage operations:</p>
<ul>

<li>create/update by key</li>
<li>retrieve by key</li>
<li>delete by key</li>
</ul>
<p>These operations are manifested as Java interfaces in the <code>reflex-cep-storage</code> module in the interfaces <code>RiskAssessmentRepository</code> and <code>SuspendedRiskAssessmentRepository</code>.</p>
<p>An integrator can adapt the storage mechanism in the following ways:</p>
<ul>

<li>configuring alternative JDBC data sources for spring-data-jpa</li>
<li>configuring alternative spring-data implementation</li>
<li>provide a custom implementation of the mentioned repository interfaces</li>
</ul>
<p>The storage mechanism can be changed individually for each repository type. This allows combinations of different storage mechanisms for different types of data. A common configuration would be to store active <code>RiskAssessment</code>s in a hazelcast repository to support interactive collaboration by a Customer Service Application with low latency when filling out the questionnaire, while keeping <code>SuspendedRiskAssessment</code>s in a classic JDBC database using spring-data-jpa for long-term storage.</p><section>
<h2><a name="Configuring_CEP_for_JDBC_databases_using_spring-data-jpa"></a>Configuring CEP for JDBC databases using spring-data-jpa</h2>
<p>To enable the JPA storage mechanism for a repository, configure the <code>config.properties</code> entry <code>com.hannoverre.reflex.cep.storage.&lt;repository&gt;.mode</code> to the value <code>jpa</code> for each deployed service that uses the repository.</p>
<p><b>Example</b>:</p>
<ul>

<li>Set <code>com.hannoverre.reflex.cep.storage.riskassessment.mode=jpa</code> in <a href="./configuration/cep-core.html"><code>${REFLEX_CONFIG_ROOTDIR}/cep-core/config.properties</code></a></li>
</ul>
<p>As described in each service configuration section, an integrator can change the JDBC data source by changing the JDBC connection URL in the configuration.</p>
<p>An integrator may use another JDBC driver by setting the JDBC driver class in the persistence unit configuration <i>and</i> adding the JDBC driver to the runtime classpath. This can be achieved by bundling the driver with the deployable war file or by adding the driver to the application servers library path (this is application server specific).</p>
<p>Each data source <i>D</i> (<code>riskassessment</code> or <code>suspendedriskassessment</code>) can be configured with the following keys:</p>
<table border="0" class="table table-striped">
<thead>

<tr class="a">
<th>Key</th>
<th>Default value</th></tr>
</thead><tbody>

<tr class="b">
<td>com.hannoverre.reflex.cep.storage.<i>D</i>.type</td>
<td><code>jpa</code></td></tr>
<tr class="a">
<td>com.hannoverre.reflex.cep.storage.<i>D</i>.datasource.logAbandoned</td>
<td><code>false</code></td></tr>
<tr class="b">
<td colspan="2">com.hannoverre.reflex.cep.storage.<i>D</i>.datasource.connectionProperties</td></tr>
<tr class="a">
<td>com.hannoverre.reflex.cep.storage.<i>D</i>.datasource.defaultAutoCommit</td>
<td><code>true</code></td></tr>
<tr class="b">
<td colspan="2">com.hannoverre.reflex.cep.storage.<i>D</i>.datasource.defaultCatalog</td></tr>
<tr class="a">
<td>com.hannoverre.reflex.cep.storage.<i>D</i>.datasource.defaultTransactionIsolation</td>
<td><code>-1</code></td></tr>
<tr class="b">
<td colspan="2">com.hannoverre.reflex.cep.storage.<i>D</i>.datasource.driver</td></tr>
<tr class="a">
<td>com.hannoverre.reflex.cep.storage.<i>D</i>.datasource.initialSize</td>
<td><code>1</code></td></tr>
<tr class="b">
<td>com.hannoverre.reflex.cep.storage.<i>D</i>.datasource.maxTotal</td>
<td><code>8</code></td></tr>
<tr class="a">
<td>com.hannoverre.reflex.cep.storage.<i>D</i>.datasource.maxIdle</td>
<td><code>8</code></td></tr>
<tr class="b">
<td>com.hannoverre.reflex.cep.storage.<i>D</i>.datasource.maxOpenPreparedStatements</td>
<td><code>-1</code></td></tr>
<tr class="a">
<td>com.hannoverre.reflex.cep.storage.<i>D</i>.datasource.maxWaitMillis</td>
<td><code>-1</code></td></tr>
<tr class="b">
<td>com.hannoverre.reflex.cep.storage.<i>D</i>.datasource.minEvictableIdleTimeMillis</td>
<td><code>1800000</code></td></tr>
<tr class="a">
<td>com.hannoverre.reflex.cep.storage.<i>D</i>.datasource.minIdle</td>
<td><code>0</code></td></tr>
<tr class="b">
<td>com.hannoverre.reflex.cep.storage.<i>D</i>.datasource.numTestsPerEvictionRun</td>
<td><code>3</code></td></tr>
<tr class="a">
<td colspan="2">com.hannoverre.reflex.cep.storage.<i>D</i>.datasource.password</td></tr>
<tr class="b">
<td>com.hannoverre.reflex.cep.storage.<i>D</i>.datasource.poolPreparedStatements</td>
<td><code>false</code></td></tr>
<tr class="a">
<td>com.hannoverre.reflex.cep.storage.<i>D</i>.datasource.removeAbandonedOnBorrow</td>
<td><code>false</code></td></tr>
<tr class="b">
<td>com.hannoverre.reflex.cep.storage.<i>D</i>.datasource.removeAbandonedOnMaintenance</td>
<td><code>false</code></td></tr>
<tr class="a">
<td>com.hannoverre.reflex.cep.storage.<i>D</i>.datasource.removeAbandonedTimeout</td>
<td><code>300</code></td></tr>
<tr class="b">
<td>com.hannoverre.reflex.cep.storage.<i>D</i>.datasource.testOnBorrow</td>
<td><code>true</code></td></tr>
<tr class="a">
<td>com.hannoverre.reflex.cep.storage.<i>D</i>.datasource.testOnReturn</td>
<td><code>false</code></td></tr>
<tr class="b">
<td>com.hannoverre.reflex.cep.storage.<i>D</i>.datasource.testWhileIdle</td>
<td><code>false</code></td></tr>
<tr class="a">
<td>com.hannoverre.reflex.cep.storage.<i>D</i>.datasource.timeBetweenEvictionRunsMillis</td>
<td><code>-1</code></td></tr>
<tr class="b">
<td colspan="2">com.hannoverre.reflex.cep.storage.<i>D</i>.datasource.url</td></tr>
<tr class="a">
<td colspan="2">com.hannoverre.reflex.cep.storage.<i>D</i>.datasource.username</td></tr>
<tr class="b">
<td colspan="2">com.hannoverre.reflex.cep.storage.<i>D</i>.datasource.validationQuery</td></tr>
<tr class="a">
<td>com.hannoverre.reflex.cep.storage.<i>D</i>.datasource.validationQueryTimeout</td>
<td><code>-1</code></td></tr>
</tbody>
</table>
<p>These properties are used to configure the <a class="externalLink" href="https://commons.apache.org/proper/commons-dbcp/api-2.1.1/index.html">Apache Commons DBCP2 BasicDataSource</a>.</p></section><section>
<h2><a name="Configuring_CEP_for_hazelcast"></a>Configuring CEP for hazelcast</h2>
<p>To enable the hazelcast storage mechanism for a repository, configure the <code>config.properties</code> entry <code>com.hannoverre.reflex.cep.storage.&lt;repository&gt;.mode</code> to the value <code>hazelcast</code> for each deployed service that uses the repository.</p>
<p><b>Example</b>:</p>
<ul>

<li>Set <code>com.hannoverre.reflex.cep.storage.riskassessment.mode=hazelcast</code> in <a href="./configuration/cep-core.html"><code>${REFLEX_CONFIG_ROOTDIR}/cep-core/config.properties</code></a></li>
</ul>
<p>Hazelcast is a distributed in-memory grid solution. It supports automatic replication that prevents data loss when single nodes fail or get restarted. It is the preferred CEP storage mechanism for deployment scenarios with strong privacy regulations. It ensures that all data is eventually deleted after a configurable idle timeout and no data is left after partial or full service outages.</p>
<p>CEP supports the following deployment scenarios using hazelcast:</p>
<ul>

<li>embedded and non-persistent in-memory storage for single node deployments</li>
<li>ad-hoc cluster for an elastic multi-node deployment with automatic replication and failover</li>
<li>dedicated single- or replicating multi-node hazelcast data-nodes with stateless CEP services</li>
</ul>
<p>The default configuration of hazelcast is part of each services <code>config.properties</code>. All supported configuration parameters are explained in the default configuration.</p>
<p>To set up and operate a dedicated hazelcast grid, please refer to the <a class="externalLink" href="http://docs.hazelcast.org/docs/3.6/manual/html-single/index.html">hazelcast 3.6 documentation</a>.</p></section><section>
<h2><a name="Providing_alternative_Spring-Data_implementations"></a>Providing alternative Spring-Data implementations</h2>
<blockquote>

<p>Please note: This is an advanced technique and requires development effort and basic understanding of java servlets and spring context loading.</p>
</blockquote>
<p>You can also provide your own spring-data CEP repository implementations. Therefore you must provide your own spring configuration that provides beans for:</p>
<ul>

<li><code>com.hannoverre.reflex.cep.storage.repository.riskassessment.RiskAssessmentRepository</code> and <code>com.hannoverre.reflex.cep.storage.repository.riskassessment.RiskAssessmentUpdates</code></li>
<li><code>com.hannoverre.reflex.cep.storage.repository.suspendedriskassessment.SuspendedRiskAssessmentRepository</code></li>
</ul>
<blockquote>

<p>Breaking change: As with Reflex release 14 CEP was migrated from Spring-Data 1.x to 2.x and with the change implementations of RiskAssessmentRepository and SuspendedRiskAssessmentRepository will break. To migrate your own implementation please rename the following methods: <b>findOne</b> to  <b>findById</b>, <b>delete</b> to <b>deleteById</b> and <b>exists</b> to <b>existsById</b>.</p>
</blockquote>
<p>An example configuration for a custom <code>RiskAssessment</code> storage could be:</p>

<div class="source">
<div class="source"><pre class="prettyprint">package com.myorg.cep;

import com.hannoverre.reflex.cep.model.assessment.RiskAssessment;
import com.hannoverre.reflex.cep.storage.repository.riskassessment.RiskAssessmentRepository;
import com.hannoverre.reflex.cep.storage.repository.riskassessment.RiskAssessmentUpdates;
import org.springframework.context.annotation.*;
import org.springframework.core.type.AnnotatedTypeMetadata;

/**
 * Configuration that provides a custom RiskAssessmentRepository.
 */
@Configuration
public class MyCustomRiskAssessmentRepositoryContext {

	@Bean
    public RiskAssessmentRepository riskAssessmentRepository() {
        final HazelcastInstance instance = hazelcastInstance();
        return new MyCustomRiskAssessmentRepository();
    }

    @Bean
    public RiskAssessmentUpdates riskAssessmentUpdates() {
        return new MyCustomRiskAssessmentUpdatesService();
    }
}
</pre></div></div>

<p>You can compile this class against the classpath of the <code>com.hannoverre.reflex.cep.core-&lt;version&gt;.war</code> artefact. To add this repository to the CEP, you need to add the implementation of <code>MyCustomRiskAssessmentRepositoryContext</code> and all your implementation classes to the runtime classpath of the web application (either by providing it as shared library to your servlet container or modifying the war file).</p>
<p>Then you need to disable the CEP default storage providers by configuring <code>com.hannoverre.reflex.cep.storage.riskassessment.mode=custom</code> the service <code>config.properties</code>.</p>
<p>Finally you need to add your <code>MyCustomRiskAssessmentRepositoryContext</code> to the spring <code>contextConfigLocation</code> servlet init-param from</p>

<div class="source">
<div class="source"><pre class="prettyprint">&lt;servlet&gt;
        &lt;servlet-name&gt;SpringMvcDispatcher&lt;/servlet-name&gt;
        &lt;!-- ... --&gt;
        &lt;init-param&gt;
            &lt;param-name&gt;contextConfigLocation&lt;/param-name&gt;
            &lt;param-value&gt;com.hannoverre.reflex.cep.core.CoreContext&lt;/param-value&gt;
        &lt;/init-param&gt;
        &lt;!-- ... --&gt;
    &lt;/servlet&gt;
</pre></div></div>

<p>to</p>

<div class="source">
<div class="source"><pre class="prettyprint">&lt;servlet&gt;
        &lt;servlet-name&gt;SpringMvcDispatcher&lt;/servlet-name&gt;
        &lt;!-- ... --&gt;
        &lt;init-param&gt;
            &lt;param-name&gt;contextConfigLocation&lt;/param-name&gt;
            &lt;param-value&gt;com.hannoverre.reflex.cep.core.CoreContext,com.myorg.cep.MyCustomRiskAssessmentRepositoryContext&lt;/param-value&gt;
        &lt;/init-param&gt;
        &lt;!-- ... --&gt;
    &lt;/servlet&gt;
</pre></div></div>

<p>Overriding init-parameters is not covered by the servlet spec and depends on the servlet container in use (please refer to its documentation). As a last resort, you can also modify the delivered war file and change the contained <code>./WEB-INF/web.xml</code>.</p>
<p>This approach can also be used for <code>SuspendedRiskAssessmentRepository</code>. Note that they do not require an equivalent of <code>RiskAssessmentUpdates</code>.</p></section><section>
<h2><a name="Maintenance_for_RDBMS"></a>Maintenance for RDBMS</h2>
<p>CEP assumes its storage mechanism to be eventually lossy for data privacy reasons. Therefore it does not contain any mechanism to automatically clean up a persistent data storage like a standard RDBMS.</p>
<p>We highly recommend using a volatile storage module that will eventually loose data (using reliable distributed key-value stores with eviction strategies).</p>
<p>However, if you decide to employ a persistent storage as CEP persistence backend, you are responsible to delete data from this data storage to comply with the local data privacy laws and regulations.</p>
<p>The <a href="#Configuring_CEP_for_JDBC_databases_using_spring-data-jpa">CEP JPA storage mechanism</a> uses a very simple database schema with the following entries:</p>
<p><b>Table <code>activeRiskAssessments</code> with:</b></p>
<ul>

<li><code>id</code>-Field (typed as Primary Key, VarChar)</li>
<li><code>document</code>-Field, typed as LOB String (CLOB)</li>
</ul>
<p>The <code>activeRiskAssessments</code> <code>document</code> column contains a JSON representation of the stored assessment.</p>
<p><b>Table <code>suspendedRiskAssessment</code> with:</b></p>
<ul>

<li><code>id</code>-Field (typed as Primary Key, VarChar)</li>
<li><code>document</code>-Field, typed as LOB String (CLOB)</li>
</ul>
<p>The <code>suspendedRiskAssessments</code> <code>document</code> column contains a JSON representation of an object containing the original assessment id and a stored assessment. Example:</p>

<div class="source">
<div class="source"><pre class="prettyprint">{
  &quot;assessmentId&quot;: &quot;The original assessment id&quot;,
  &quot;riskAssessment&quot;: { ... } /* the original assessment */
}
</pre></div></div>

<p>It is a common requirement to delete assessments that are &#x201c;older&#x201d; than a certain age (e.g. one month or 60 days). That &#x201c;age&#x201d; may be measured from the time the assessment has been created or the time the assessment has been edited the last time. To make these timestamps queryable, you can use database triggers to create columns that keep track of these timestamps.</p>
<p>As the details depend on the data protection laws and regulations applicable in the local market, the following information can only serve as an example on how a solution could be implemented.</p><section>
<h3><a name="Create_timestamp_tracking_columns"></a>Create timestamp tracking columns</h3>
<p>The following snippets use the MSSQL server dialect to show how to create columns to track creation date and last modified date for <code>activeRiskAssessments</code>.</p>
<p>Your database administrator may adapt the following statements according to the SQL dialect used by your RDBMS.</p>

<div class="source">
<div class="source"><pre class="prettyprint">ALTER TABLE activeRiskAssessments
    ADD created DATETIME2 DEFAULT CURRENT_TIMESTAMP;

ALTER TABLE activeRiskAssessments
    ADD modified DATETIME2 DEFAULT CURRENT_TIMESTAMP;

CREATE TRIGGER activeRiskAssessmentsOnUpdate
    ON activeRiskAssessments
    AFTER UPDATE
    AS
    UPDATE activeRiskAssessments
    SET modified = CURRENT_TIMESTAMP
    WHERE ID IN (SELECT DISTINCT ID FROM Inserted);
</pre></div></div>

<p>This script will add two new columns <code>created</code> and <code>modified</code> to the schema table that are updated automatically. The column <code>created</code> contains the timestamp of the creation time of the risk assessment. The column <code>modified</code> contains the timestamp of the latest modification time of the risk assessment.</p></section><section>
<h3><a name="Examples_for_database_maintenance_scripts"></a>Examples for database maintenance scripts</h3>
<p>Once you have set up the <code>created</code> and <code>modified</code> columns, you may use the following scripts as guideline for automated database maintenance tasks.</p>
<p>The following snippets use the MSSQL server dialect to illustrate how to create a query that deletes risk assessments based on different criteria.</p>
<p>Your database administrator may adapt the following statements according to the SQL dialect used by your RDBMS.</p>
<p><b>Delete all assessments that have been created more than 30 days ago</b></p>

<div class="source">
<div class="source"><pre class="prettyprint">DELETE FROM activeRiskAssessments
WHERE (DATEDIFF(d, CURRENT_TIMESTAMP, activeRiskAssessments.modified) &gt; 30)
</pre></div></div>

<p><b>Delete all assessments with knowledge base version 6.0.0 that have not been modified for more than 30 days and have the medical rating &#x201c;Offer&#x201d;</b></p>

<div class="source">
<div class="source"><pre class="prettyprint">DELETE FROM activeRiskAssessments
WHERE (DATEDIFF(d, CURRENT_TIMESTAMP, activeRiskAssessments.modified) &gt; 30
      AND JSON_VALUE(activeRiskAssessments.document, '$.meta.ras.knowledgebase.version') == '6.0.0')
      OR JSON_VALUE(activeRiskAssessments.document, '$.results.products[0].ratings.Medical[0].decision') = 'Offer');
</pre></div></div>

<p>Be aware that the structure of the JSON document with the assessment data may change with upcoming ReFlex versions. Such changes will be announced in the migration notes of the RAS module.</p></section></section>
                  </div>
            </div>
          </div>

    <hr/>

    <footer>
            <div class="container-fluid">
                      <div class="row-fluid">
                                      <p >Copyright &copy;                   2020.
          All rights reserved.    
      </p>
                </div>

        
                </div>
    </footer>
        </body>
</html>
