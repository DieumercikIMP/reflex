<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia Site Renderer 1.9.2 at 2020-09-25 
 | Rendered using Apache Maven Fluido Skin 1.5
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="Date-Revision-yyyymmdd" content="20200925" />
    <meta http-equiv="Content-Language" content="en" />
    <title>ReFlex ReFlex Integrator's Handbook &#x2013; Security</title>
    <link rel="stylesheet" href="../../../../css/apache-maven-fluido-1.5.min.css" />
    <link rel="stylesheet" href="../../../../css/site.css" />
    <link rel="stylesheet" href="../../../../css/print.css" media="print" />

      
    <script type="text/javascript" src="../../../../js/apache-maven-fluido-1.5.min.js"></script>

                      </head>
        <body class="topBarDisabled">
          
        
    
        <div class="container-fluid">
          <div id="banner">
        <div class="pull-left">
                                    <a href="https://www.hannover-re.com/" id="bannerLeft">
                                                                                                <img src="../../../../images/logo.svg"  alt="HannoverRe"/>
                </a>
                      </div>
        <div class="pull-right">                  <a href="https://www.hannover-re.com/" id="bannerRight">
                                                                                                <img src="../../../../images/hre-logo.svg"  alt="HannoverRe_log"/>
                </a>
      </div>
        <div class="clear"><hr/></div>
      </div>

      <div id="breadcrumbs">
        <ul class="breadcrumb">
              
                  <li id="projectVersion">Version: 15.0.0
                    </li>
              
              
                  <li id="publishDate" class="pull-right">Last Published: 2020-09-25</li>
            
                            </ul>
      </div>

            
      <div class="row-fluid">
        <div id="leftColumn" class="span2">
          <div class="well sidebar-nav">
              
                <ul class="nav nav-list">
                          
      <li>
  
                          <a href="../../../../index.html" title="Document Information">
          <span class="none"></span>
        Document Information</a>
            </li>
                                                                                                                                                            
      <li>
  
                          <a href="../../../../reflex-overview/index.html" title="ReFlex Overview">
          <span class="icon-chevron-right"></span>
        ReFlex Overview</a>
                  </li>
                
      <li>
  
                          <a href="../../../../installation-guide.html" title="Installation Guide">
          <span class="none"></span>
        Installation Guide</a>
            </li>
                                                                                                      
      <li>
  
                          <a href="../../../../update-guide/index.html" title="Update Guide">
          <span class="icon-chevron-right"></span>
        Update Guide</a>
                  </li>
                                                                                                                        
      <li>
  
                          <a href="../../../../use-cases/index.html" title="Use Cases">
          <span class="icon-chevron-right"></span>
        Use Cases</a>
                  </li>
                              <li class="nav-header">RAS documentation</li>
                              
      <li>
  
                          <a href="../../../../ras/overview.html" title="Overview">
          <span class="none"></span>
        Overview</a>
            </li>
                                                                                                      
      <li>
  
                          <a href="../../../../ras/configuration.html" title="Configuration">
          <span class="icon-chevron-right"></span>
        Configuration</a>
                  </li>
                                                                                                      
      <li>
  
                          <a href="../../../../ras/general-notes/index.html" title="General Notes">
          <span class="icon-chevron-right"></span>
        General Notes</a>
                  </li>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
      <li>
  
                          <a href="../../../../ras/rest-resources/index.html" title="REST API">
          <span class="icon-chevron-right"></span>
        REST API</a>
                  </li>
                                                                                                                                                                                                                                                      
      <li>
  
                          <a href="../../../../ras/usage-scenarios/index.html" title="Usage Scenarios">
          <span class="icon-chevron-right"></span>
        Usage Scenarios</a>
                  </li>
                                                                                                                                          
      <li>
  
                          <a href="../../../../ras/known-issues/index.html" title="Known Issues">
          <span class="icon-chevron-right"></span>
        Known Issues</a>
                  </li>
                              <li class="nav-header">CEP documentation</li>
                              
      <li>
  
                          <a href="../../../../cep/integration/integration_mechanism.html" title="Integration Mechanism">
          <span class="none"></span>
        Integration Mechanism</a>
            </li>
                                                                                                                                                                                          
      <li>
  
                          <a href="../../../../cep/integration/backend/index.html" title="Back End Integration">
          <span class="icon-chevron-right"></span>
        Back End Integration</a>
                  </li>
                                                                                                                                                                                                                        
      <li>
  
                          <a href="../../../../cep/integration/frontend/index.html" title="Front End Integration">
          <span class="icon-chevron-right"></span>
        Front End Integration</a>
                  </li>
                                                                                    
      <li>
  
                          <a href="../../../../cep/integration/features/index.html" title="Optional Features">
          <span class="icon-chevron-right"></span>
        Optional Features</a>
                  </li>
                                                                                                                                        
      <li>
  
                          <a href="../../../../cep/integration/operations/index.html" title="Operations">
          <span class="icon-chevron-down"></span>
        Operations</a>
                    <ul class="nav nav-list">
                                                                          
      <li class="active">
  
            <a href="#"><span class="icon-chevron-down"></span>Security</a>
                  <ul class="nav nav-list">
                    
      <li>
  
                          <a href="../../../../cep/integration/operations/security/filter_configuration.html" title="Filter Configuration">
          <span class="none"></span>
        Filter Configuration</a>
            </li>
              </ul>
        </li>
                    
      <li>
  
                          <a href="../../../../cep/integration/operations/deployment.html" title="Deployment">
          <span class="none"></span>
        Deployment</a>
            </li>
                    
      <li>
  
                          <a href="../../../../cep/integration/operations/logging.html" title="Logging">
          <span class="none"></span>
        Logging</a>
            </li>
              </ul>
        </li>
                
      <li>
  
                          <a href="../../../../cep/integration/known_issues.html" title="Known Issues">
          <span class="none"></span>
        Known Issues</a>
            </li>
                              <li class="nav-header">DCS documentation</li>
                              
      <li>
  
                          <a href="../../../../dcs/index.html" title="Overview">
          <span class="none"></span>
        Overview</a>
            </li>
                
      <li>
  
                          <a href="../../../../dcs/configuration.html" title="Configuration">
          <span class="none"></span>
        Configuration</a>
            </li>
                
      <li>
  
                          <a href="../../../../dcs/rest-api.html" title="REST API">
          <span class="none"></span>
        REST API</a>
            </li>
                                                                                                      
      <li>
  
                          <a href="../../../../dcs/template-config/template-configuration.html" title="Template Configuration">
          <span class="icon-chevron-right"></span>
        Template Configuration</a>
                  </li>
                
      <li>
  
                          <a href="../../../../dcs/known-issues.html" title="Known Issues">
          <span class="none"></span>
        Known Issues</a>
            </li>
                              <li class="nav-header">RSP documentation</li>
                                                                                                                                                        
      <li>
  
                          <a href="../../../../rsp/integration/integration.html" title="Integration">
          <span class="icon-chevron-right"></span>
        Integration</a>
                  </li>
                                                                                                                                                                                    
      <li>
  
                          <a href="../../../../rsp/configuration/configuration.html" title="Configuration">
          <span class="icon-chevron-right"></span>
        Configuration</a>
                  </li>
                              <li class="nav-header">MI documentation</li>
                              
      <li>
  
                          <a href="../../../../mi/installation/app-queue.html" title="AppQueue Installation">
          <span class="none"></span>
        AppQueue Installation</a>
            </li>
                                                                                    
      <li>
  
                          <a href="../../../../mi/index.html" title="Data export">
          <span class="icon-chevron-right"></span>
        Data export</a>
                  </li>
                              <li class="nav-header">3PS documentation</li>
                              
      <li>
  
                          <a href="../../../../tps/overview.html" title="Overview">
          <span class="none"></span>
        Overview</a>
            </li>
                                                                                                                        
      <li>
  
                          <a href="../../../../tps/configuration.html" title="Configuration">
          <span class="icon-chevron-right"></span>
        Configuration</a>
                  </li>
                                                                                    
      <li>
  
                          <a href="../../../../tps/api.html" title="REST API">
          <span class="icon-chevron-right"></span>
        REST API</a>
                  </li>
                              <li class="nav-header">UWB documentation</li>
                              
      <li>
  
                          <a href="../../../../uwb/index.html" title="Overview">
          <span class="none"></span>
        Overview</a>
            </li>
                                                                  
      <li>
  
                          <a href="../../../../uwb/installation/index.html" title="Installation">
          <span class="icon-chevron-right"></span>
        Installation</a>
                  </li>
                                                                                                                        
      <li>
  
                          <a href="../../../../uwb/configuration/application/index.html" title="Application Configuration">
          <span class="icon-chevron-right"></span>
        Application Configuration</a>
                  </li>
                                                                                                                                                                                    
      <li>
  
                          <a href="../../../../uwb/configuration/office/index.html" title="Office Configuration">
          <span class="icon-chevron-right"></span>
        Office Configuration</a>
                  </li>
                                                                                                                                                                                    
      <li>
  
                          <a href="../../../../uwb/features/index.html" title="Advanced Features">
          <span class="icon-chevron-right"></span>
        Advanced Features</a>
                  </li>
                                                                  
      <li>
  
                          <a href="../../../../uwb/operations/index.html" title="Operations">
          <span class="icon-chevron-right"></span>
        Operations</a>
                  </li>
                
      <li>
  
                          <a href="../../../../uwb/known_issues.html" title="Known Issues">
          <span class="none"></span>
        Known Issues</a>
            </li>
                              <li class="nav-header">MIGRATION documentation</li>
                              
      <li>
  
                          <a href="../../../../migration/index.html" title="User Guide">
          <span class="none"></span>
        User Guide</a>
            </li>
                              <li class="nav-header">Appendix</li>
                              
      <li>
  
                          <a href="../../../../glossary.html" title="Glossary">
          <span class="none"></span>
        Glossary</a>
            </li>
                
      <li>
  
                          <a href="../../../../component-versions.html" title="Component Versions">
          <span class="none"></span>
        Component Versions</a>
            </li>
                                                                                                                                          
      <li>
  
                          <a href="../../../../release-migration-notes.html" title="Release And Migration Notes">
          <span class="icon-chevron-right"></span>
        Release And Migration Notes</a>
                  </li>
                
      <li>
  
                          <a href="../../../../changelog.html" title="Changelog">
          <span class="none"></span>
        Changelog</a>
            </li>
            </ul>
              
                
          <hr />

           <div id="poweredBy">
                            <div class="clear"></div>
                            <div class="clear"></div>
                            <div class="clear"></div>
                            <div class="clear"></div>
                             <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy">
        <img class="builtBy" alt="Built by Maven" src="../../../../images/logos/maven-feather.png" />
      </a>
                  </div>
          </div>
        </div>
        
                
        <div id="bodyColumn"  class="span10" >
                                  
            <section>
<h2><a name="Security"></a>Security</h2>
<p>The JSON Web Token (JWT) is the core security mechanism for authentication and authorization in the CEP architecture. This chapter will explain the JWT structure, its usage, storage, and the authentication and authorization mechanism.</p>
<p>Please have a look at the following sections:</p>
<ul>

<li><a href="#introduction">Introduction and definitions</a></li>
<li><a href="#jwt_structure">JSON Web Token structure</a></li>
<li><a href="#jwt_header">Authorization request header</a></li>
<li><a href="#jwt_evaluation">Token evaluation</a></li>
<li><a href="#keystore_configuration">Keystore configuration</a></li>
<li><a href="#jwt_storage">Safe token storage in the client</a></li>
</ul>
<p><a name="introduction"></a></p><section>
<h3><a name="Introduction_and_definitions"></a>Introduction and definitions</h3>
<p>The CEP uses big parts of the <a class="externalLink" href="https://tools.ietf.org/html/rfc7165">JSON Object Signing and Encryption (JOSE)</a> specification to provide authentication and authorization facilities. Each interaction between a user-agent and a public CEP endpoint has to be authenticated by a <a class="externalLink" href="http://tools.ietf.org/html/rfc7519">JSON Web Token (JWT)</a>. The JWTs are transported either via HTTP-Cookie or HTTP-Authentication header according to <a class="externalLink" href="https://tools.ietf.org/html/rfc6750">OAuth 2 Access Token</a></p>
<p>A JWT for a user can either be provided by the integrating client portal or created by the <b>CEP Core Integration Endpoint</b>. JWTs contain a signed set of claims with expiry-information which can be validated by each service locally.</p>
<p><a name="jwt_structure"></a></p></section><section>
<h3><a name="JSON_Web_Token_.28JWT.29_structure"></a>JSON Web Token (JWT) structure</h3>
<p>JSON Web Token is a JSON-based open standard (see <a class="externalLink" href="http://tools.ietf.org/html/rfc7519">RFC 7519</a>) for passing claims between parties in a web application environment. It is a compact, URL-safe string, consisting of the three parts header, payload, and signature, separated by a &#x201c;.&#x201d; (As defined in <a class="externalLink" href="https://tools.ietf.org/html/rfc7515">JSON Web Signature (JWS)</a>). An example of a token is given below:</p>

<div class="source">
<div class="source"><pre class="prettyprint">eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.
eyJ1aWQiOiI4MzEzOWQwNC1kNjIwLTQwOGQtYjU2MC0zZjBhYzk
5YTBhZmUiLCJleHAiOjE0MzkyMTIzNTAsInN1YiI6IkNTUCBQb
3J0YWwiLCJpc3MiOiJDU1AiLCJhdWQiOiJ1c2VyIiwianRpIjoi
MmM0MzJjMjctNGQxOS00ZGI2LTk4OGQtMjRhMjE0YWRhZWRjIiwi
aWF0IjoxNDM5MjA4NzUwfQ.
VOs1z_zP_s7A8g61BJmqg6VGmAfnS1BeGR9l6Zx7yTk
</pre></div></div>

<p>The first two parts, i.e. header and payload, are Base64-encoded JSON structures, while the signature is created by a hashing algorithm (see header definition below).</p>
<p>The JWT specification also describes encrypted JWTs according to <a class="externalLink" href="https://tools.ietf.org/html/rfc7516">JSON Web Encryption (JWE)</a>. These Tokens are not yet supported by CEP.</p><section>
<h4><a name="Header"></a>Header</h4>
<p>The header carries two mandatory parameters:</p>
<ul>

<li><code>typ</code>: The type of the token, which is &#x201c;JWT&#x201d;.</li>
<li><code>alg</code>: The hashing algorithm that created the signature and must be used to verify the token.</li>
</ul>
<p>It may contain the following optional headers:</p>
<ul>

<li>&#x2018;kid&#x2019;: Key identifier that identifies the key that has been used to sign this token. This is required when then back end supports different signing keys for the same signature algorithm.</li>
</ul>
<p>For the example token given above the decoded header part would look like this:</p>

<div class="source">
<div class="source"><pre class="prettyprint">{
	&quot;typ&quot;: &quot;JWT&quot;,
	&quot;alg&quot;: &quot;HS256&quot;,
	&quot;kid&quot;: &quot;client-key-2016&quot;
}
</pre></div></div>
</section><section>
<h4><a name="Payload"></a>Payload</h4>
<p>The payload is the core of a JWT and carries provided information known as <b>claims</b>. These can be separated into the following types.</p><section>
<h5><a name="Registered_claims"></a>Registered claims</h5>
<p>Reserved but not mandatory claims providing context information about the token. Currently, the following claims are used in CEP:</p>
<table border="0" class="table table-striped">
<thead>

<tr class="a">
<th>Claim		  	</th>
<th> Meaning						                                </th>
<th> Value</th></tr>
</thead><tbody>

<tr class="b">
<td><code>sub</code>		 	</td>
<td> The subject of the token		                                </td>
<td> The value for <code>subject</code> given by the <a href="../../backend/rest_api/cep-core.html#aoperationsinitializeAssessment">initialize request against the Integration Endpoint</a></td></tr>
<tr class="a">
<td><code>exp</code>		 	</td>
<td> The expiration date of the token as a NumericDate value       </td>
<td> Timestamp(<i>Creation Time</i> + <code>com.hannoverre.reflex.cep.service.integration.signing.expirationTime</code>)</td></tr>
<tr class="b">
<td><code>nbf</code>		 	</td>
<td> The time before the token <b>must not be</b> accepted            </td>
<td> Timestamp(<i>Creation Time</i> + <code>com.hannoverre.reflex.cep.security.signing.notBeforeTimeOffset</code>)</td></tr>
<tr class="a">
<td><code>iat</code>		 	</td>
<td> The time the token was issued, e.g. for determining token age </td>
<td> Timestamp(<i>Creation Time</i>)</td></tr>
<tr class="b">
<td><code>jti</code>			</td>
<td> Unique id for the token 		                                </td>
<td> A unique string generated by the framework</td></tr>
<tr class="a">
<td><code>scopes</code>		</td>
<td> List of scopes the token owner is allowed to access	        </td>
<td> An array of scope identifiers</td></tr>
</tbody>
</table>
<p>CEP requires another non-standard claim &#x2018;scopes&#x2019; as suggested by OAuth2 that contains a comma-separated list of security scopes (think of them as roles). Each CEP endpoint may require a different set of scopes.</p></section><section>
<h5><a name="Public_claims"></a>Public claims</h5>
<p>Claims that provide processable information for subsystems. These can be any kind of information, like a user id or roles the token holder possesses.</p>
<p>The decoded payload part of the given example looks like this:</p>

<div class="source">
<div class="source"><pre class="prettyprint">{
	&quot;uid&quot;: &quot;83139d04-d620-408d-b560-3f0ac99a0afe&quot;,
	&quot;exp&quot;: 1439212350,
	&quot;sub&quot;: &quot;a-reference-to-the-resource-owner&quot;,
	&quot;iss&quot;: &quot;CEP&quot;,
	&quot;aud&quot;: &quot;user&quot;,
	&quot;jti&quot;: &quot;2c432c27-4d19-4db6-988d-24a214adaedc&quot;,
	&quot;iat&quot;: 1439208750,
	&quot;scope&quot;: [
        &quot;reflex.cep.assessment&quot;
      ]
}
</pre></div></div>

<p><b>Note:</b> All Information put into the header and payload fields are visible for whomever holds this token. Therefore, sensible information like passwords <b>must not</b> be stored in the token!</p></section></section><section>
<h4><a name="Signature"></a>Signature</h4>
<p>The signature is the third part of the token and is a hash using the header, the payload, and a secret - a key stored on the server - that <b>must not</b> be transmitted. The hash will be created with the hashing algorithm provided in the header of the token.</p>
<p>Again, taking the example from above, the signature will be the result of:</p>

<div class="source">
<div class="source"><pre class="prettyprint">HMACSHA256(
	base64UrlEncode(header) +
	&quot;.&quot; +
	base64UrlEncode(payload),
	secret
);
</pre></div></div>

<p><a name="jwt_header"></a></p></section></section><section>
<h3><a name="Authorization_request_header"></a>Authorization request header</h3>
<p>The CEP service offers access to the risk assessment services as well as to stored assessment data. To prevent unauthorized access to these services and data, almost every CEP endpoint is configured to expect an Authorization cookie or header containing a valid JSON web token. This token is extracted and - depending on the particular request - evaluated according to authentication and authorization permissions.</p>
<p>Sample request structure:</p>

<div class="source">
<div class="source"><pre class="prettyprint">GET /some/cep/service
Cookie: Authorization=Bearer%20valid-cep-token
</pre></div></div>

<p>To allow alternative, browser-less integrations, the JWT may also be provided as Authorization Request Header according to <a class="externalLink" href="https://tools.ietf.org/html/rfc6750#section-2.1">RFC6750 section 2.1</a>:</p>

<div class="source">
<div class="source"><pre class="prettyprint">GET /some/cep/service
Authorization: Bearer valid-cep-token
</pre></div></div>

<p><a name="jwt_evaluation"></a></p></section><section>
<h3><a name="Token_evaluation"></a>Token evaluation</h3>
<p>In CEP, the JWT is used for authentication and authorization purposes. It contains a signature to validate that the token has been issued by an authoritative party and a subject to identify the actual resource owner. Additionally each service can define a set of required scopes that have to be provided by a given token to allow access to a resource.</p>
<p>If the authentication or authorization fails, each CEP service will respond with a proper HTTP status code. It also provides a reason why an authentication or authorization failed using the <code>WWW-Authenticate</code> response-header according to RFC6750 section 3.1.</p>
<table border="0" class="table table-striped">
<thead>

<tr class="a">
<th>Code	</th>
<th> Name					</th>
<th> Description</th></tr>
</thead><tbody>

<tr class="b">
<td>401		</td>
<td> Unauthorized			</td>
<td> The access token is missing or invalid and thus, the request could not be authenticated. The response-header <code>WWW-Authenticate</code>contains further information about the error.</td></tr>
<tr class="a">
<td>403		</td>
<td> Forbidden            	</td>
<td> The access token is valid but does not contain the required claims (subject or scopes) and thus, the request could not be authorized. The response-header <code>WWW-Authenticate</code> contains further information about the error.</td></tr>
</tbody>
</table>
<p><a name="keystore_configuration"></a></p></section><section>
<h3><a name="Keystore_configuration"></a>Keystore configuration</h3>
<p>The CEP uses <a class="externalLink" href="https://tools.ietf.org/html/rfc7517#section-5">JSON Web Key Sets (JWKS)</a> to provide key material for the CEP services. The JWKS is part of the CEP configuration folder (usually as <code>keystore.json</code>). The file contains different keys that are authorized to issue access tokens for the CEP backend.</p>
<p>JWKS and the CEP security mechanism support different signature- and key-algorithms.</p>
<p>Json Web Keys (JWKs) are identified within a JWKS by their configured signature algorithm (alg) and a key identifier (kid). Each JWT should contain a key identifier in its header that matches the key identifier in the JWKS that signed the token.</p>
<p>Please note that CEP does currently not support encrypted JWKS.</p>
<p>An example <code>keystore.json</code> could look like this:</p>

<div class="source">
<div class="source"><pre class="prettyprint">{
  &quot;keys&quot;: [
	{
	  &quot;kty&quot;:&quot;oct&quot;,
	  &quot;alg&quot;:&quot;HS256&quot;,
	  &quot;k&quot;:&quot;fHVyAyDRoqRnlauxwQFjYrbNPrnonYgiSSVmFsczqwk=&quot;,
	  &quot;use&quot;:&quot;sig&quot;
	},
	{
      &quot;kid&quot;: &quot;my-ecdsa-key&quot;,
      &quot;kty&quot;: &quot;EC&quot;,
      &quot;alg&quot;: &quot;ES256&quot;,
      &quot;use&quot;: &quot;sig&quot;,
      &quot;crv&quot;: &quot;P-256&quot;,
      &quot;x&quot;: &quot;PkG5cJnisoeypl__chalOZ3k-FK_oNM2wXWUv3ZProY&quot;,
      &quot;y&quot;: &quot;dcgir8gM8RakCsZIM3RxU6okNy8pDBdG_j7W3n-zsQo&quot;,
      &quot;d&quot;: &quot;_DOi_N1iOWE_n7yMYZE579spU7eQeNReiiQt4Jbmktg&quot;
    },
	{
	  &quot;kty&quot;:&quot;RSA&quot;,
	  &quot;kid&quot;:&quot;my-key-identifier&quot;,
	  &quot;alg&quot;:&quot;RS256&quot;,
	  &quot;e&quot;:&quot;AQAB&quot;,
	  &quot;n&quot;:&quot;zzbyxW/NZAVSGdjImqGf69EuWquzmyVB7VcnHl2Un2zGkr5KOhX8XuS/cvVVHpWtE0xdlIHn+iqe7Y1Xu5AYtB68PkMazHWuhanoPnqjqTi9Rpb+8EWFFdzSpCA6LEfltLaLouZD3Ncwqoulym79a0gPe4YTzQNmBGd6RxIBfqyVqWWN4nVy0yYTdPtwHOWt0RZaJaRWqHmXITo8UhSMK2c7mtGuS9mauCaz6AeK7zWgn3jj/1CHe+4M3jnIdjRuDrCy0KXJ39X8AAI9hDEST4HzBNgN+dUTrSCwUVoUaBLHO8Ns7scG2QKu1gA30qkaqdomRtyQnWmyEW1PUd+aEQ==&quot;,
	  &quot;use&quot;:&quot;sig&quot;
	}
	]
}
</pre></div></div>

<p>This <code>keystore.json</code> contains the following keys:</p>
<p>The first key is a symmetric key (<code>&quot;kty&quot;:&quot;oct&quot;&quot;</code>) that has no key identifier and supports the HMAC SHA-256 signatures. It contains the base64 encoded symmetric key in its parameter <code>k</code> (according to rfc7518 6.4.1) and is used for signing and signature validation.</p><section>
<h4><a name="Create_a_ECDSA_keypair"></a>Create a ECDSA keypair</h4>
<p>The second key is a ECDSA private and public key with the following parameters (see also <a class="externalLink" href="https://tools.ietf.org/html/rfc7518#section-6.2.1">RFC7518 6.2.1 Parameters for Elliptic Curve Public Keys</a>):</p>
<ul>

<li><code>crv</code>: The defined NIST curve (possible values: <code>P-256</code>, <code>P-384</code> or <code>P-521</code>)</li>
<li><code>x</code>: The parameter contains the x coordinate for the Elliptic Curve point</li>
<li><code>y</code>: The parameter contains the y coordinate for the Elliptic Curve point</li>
<li><code>d</code>: contains the Elliptic Curve private key value. <b>This value must only be available in the keystore of the signing application!</b></li>
</ul>
<p>CEP recommends <code>ES256</code> as signature algorithm which uses ECDSA on a <code>P-256</code> curve.</p>
<p>To create a ECDSA keypair we recommend you to use the <a class="externalLink" href="https://github.com/mitreid-connect/json-web-key-generator/">json-web-key-generator</a>. For testing purposes, you might alternatively use  the <a class="externalLink" href="https://mkjwk.org/">mkjwk online json-web-key-generator</a> to generate keys (although we strongly suggest to not use this service for production keys!).</p>
<p>The following curve name have its counterparts in openssl:</p>
<ul>

<li>P-256 &lt;-&gt; prime256v1</li>
<li>P-384 &lt;-&gt; secp384r1</li>
</ul></section><section>
<h4><a name="Convert_RSA_key_to_JWK_using_openssl"></a>Convert RSA key to JWK using openssl</h4>
<p>The third key is a RSA public key with the following parameters:</p>
<ul>

<li><code>e</code>: exponent, according to rfc7518 6.3.1.2</li>
<li><code>n</code>: public modulus, according to rfc7518 6.3.1.1</li>
<li><code>kid</code>: key identifier, used for signature key selection</li>
</ul>
<p>The parameters exponent and modulus can be extracted from an existing certificate (<code>sample.pem</code>) using the following steps:</p>
<p>Extracting the modulus:</p>
<ul>

<li><code>openssl x509 -in sample.pem -modulus -noout | cut -c 9- | xxd -r -p | base64</code></li>
</ul>
<p>The exponent can be retrieved through the following steps:</p>
<ol style="list-style-type: decimal">

<li><code>openssl x509 -in sample.pem -text -noout</code> This will show the certificate description containing the exponent (Note: the defacto agreed default value will be <code>65537</code>, or, in hexadecimal notation: <code>0x10001</code>)</li>
<li>The hex value has to be formatted to a three columned string, where each column represents two bytes in hexadecimal notation of the input value. For ex. <code>0x1CAF3</code> will become &#x201c;<code>01</code> <code>CA</code> <code>F3</code>&#x201d; and <code>0x10001</code> will be &#x201c;<code>01</code> <code>00</code> <code>01</code>&#x201d; respectively.</li>
<li>This (white-space removed) string can now be put into the following command: <code>echo &quot;010001&quot; | xxd -r -p | base64</code>. So the initial value of <code>65537</code> will become <code>AQAB</code></li>
</ol></section><section>
<h4><a name="Convert_RSA_keys_to_JWK_using_rsa-pem-to-jwk"></a>Convert RSA keys to JWK using rsa-pem-to-jwk</h4>
<p>It might be easier using a tool like <a class="externalLink" href="https://github.com/OADA/rsa-pem-to-jwk">rsa-pem-to-jwk</a> to convert RSA-keys to JWKs.</p>
<p>Given a file <code>private.pem</code> that contains an unencrypted private PEM encoded RSA private key, you can use the following script to create a keystore that can be used to sign tokens and a keystore that can be used to verify tokens. Note that expiration dates of the given certificates are ignored during validation.</p>

<div class="source">
<div class="source"><pre class="prettyprint">npm install rsa-pem-to-jwk &amp;&amp; \
  node -e &quot;var fs = require('fs');\
  var rsaPemToJwk = require('rsa-pem-to-jwk');\
  var pem=fs.readFileSync('private.pem');\
  fs.writeFile('signingKey.json', JSON.stringify(rsaPemToJwk(pem, {use:'sig'}, 'private'), null, '\t'));\
  fs.writeFile('publicKey.json',  JSON.stringify(rsaPemToJwk(pem, {use:'sig'}, 'public'),  null, '\t'));&quot;
</pre></div></div>

<p>This script generates two JWK files: <code>signingKey.json</code> and <code>publicKey.json</code> which contain JWKs for signing and validation. You can add these JWKs to your <code>keystore.json</code>.</p></section><section>
<h4><a name="Key_resolution_mechanism"></a>Key resolution mechanism</h4>
<p>The CEP tries to validate a JWT with a given algorithm <i>alg</i> against this JWKS using the following rules:</p>
<ul>

<li>Let <i>A</i> be all keys that support the provided signature algorithm <i>alg</i>.</li>
<li>If <i>A</i> is empty, refuse the request</li>
<li>If the requests JWT contains a <i>kid</i>, use the key from <i>A</i> that has the same <i>kid</i>. If no key has a matching <i>kid</i>, refuse the request</li>
<li>If the requests JWT does not contain a key identifier, try to validate against the first key from <i>A</i></li>
</ul>
<p>This will have the following implications. You can:</p>
<ul>

<li>configure a key per signature-algorithm without specifying a <code>kid</code> in the JWKS-configuration and without providing this <code>kid</code> in each access token.</li>
<li>configure multiple keys per signature-algorithm as long as you specify a <code>kid</code> in the JWKS-configuration and provide that <code>kid</code> in each access token.</li>
<li>configure multiple keys per signature-algorithm, but not provide a KID in each requests JWT as long as those JWTs are signed with the first key in the JWKS with the given <code>alg</code>.</li>
</ul>
<p>The keystore supports all standard JWK key types.</p>
<p>The location of the keystore can be configured for each CEP service individually (see back end configuration chapters). Only the <b>Integration Endpoint</b> needs the key material to sign JWTs. All other services and endpoints only require public keys to validate JWT access tokens.</p>
<p><a name="jwt_storage"></a></p></section></section><section>
<h3><a name="Safe_token_storage_in_the_client"></a>Safe token storage in the client</h3>
<p>Because all CEP services expect the <code>Authorization</code> header field or a cookie with the key <code>Authorization</code> containing the JSON Web Token for authentication and authorization, the CEP UI needs to store the token in between different requests. There are two different mechanisms available to store a token:</p><section>
<h4><a name="HTTP_cookie"></a>HTTP cookie</h4>
<p>An HTTP cookie is a small piece of data sent from a website and stored in a user&#x2019;s web browser while browsing. The browser sends the cookie back to the server with each request to notify the website of the user&#x2019;s previous activity.</p>
<p>Cookies were designed to be a reliable mechanism for websites to remember stateful information or to record the user&#x2019;s browsing activity. They can be secured with two cookie flags:</p>
<ul>

<li><code>HttpOnly</code>: makes the cookie inaccessible through JavaScript and thus protects it from cross-site scripting attacks</li>
<li><code>Secure</code>: enforces that the cookie is transferred over HTTPS only</li>
</ul>
<p>Because of these additional security mechanisms, CEP is using an HttpOnly HTTP Cookie to store the JSON web token. We strongly suggest to also use the <code>Secure</code> flag in production environments served by HTTPS only.</p>
<p>The cookie value format for bearer token used by CEP is:</p>
<p><code>Cookie: Authentication=Bearer%20{b64token}</code> (basically an OAuth 2 access token header encoded as cookie value)</p></section><section>
<h4><a name="Authorization_request_header"></a>Authorization request header</h4>
<p>Alternatively the integrating app may provide the access token as Authorization Request Header. This can be achieved by providing an <code>$http</code> interceptor to the angular application (as described in <a class="externalLink" href="https://code.angularjs.org/1.3.19/docs/api/ng/service/$http">AngularJS $http Documentation</a>, chapter <i>Interceptors</i>) that adds this header to each CEP back end call.</p>
<p>We highly recommend to use the HTTP cookie mechanism because it provides additional security against several kinds of client side attacks.</p></section></section></section>
                  </div>
            </div>
          </div>

    <hr/>

    <footer>
            <div class="container-fluid">
                      <div class="row-fluid">
                                      <p >Copyright &copy;                   2020.
          All rights reserved.    
      </p>
                </div>

        
                </div>
    </footer>
        </body>
</html>
