<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia Site Renderer 1.9.2 at 2020-09-25 
 | Rendered using Apache Maven Fluido Skin 1.5
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="Date-Revision-yyyymmdd" content="20200925" />
    <meta http-equiv="Content-Language" content="en" />
    <title>ReFlex ReFlex Integrator's Handbook &#x2013; Authentication Interface</title>
    <link rel="stylesheet" href="../../css/apache-maven-fluido-1.5.min.css" />
    <link rel="stylesheet" href="../../css/site.css" />
    <link rel="stylesheet" href="../../css/print.css" media="print" />

      
    <script type="text/javascript" src="../../js/apache-maven-fluido-1.5.min.js"></script>

                      </head>
        <body class="topBarDisabled">
          
        
    
        <div class="container-fluid">
          <div id="banner">
        <div class="pull-left">
                                    <a href="https://www.hannover-re.com/" id="bannerLeft">
                                                                                                <img src="../../images/logo.svg"  alt="HannoverRe"/>
                </a>
                      </div>
        <div class="pull-right">                  <a href="https://www.hannover-re.com/" id="bannerRight">
                                                                                                <img src="../../images/hre-logo.svg"  alt="HannoverRe_log"/>
                </a>
      </div>
        <div class="clear"><hr/></div>
      </div>

      <div id="breadcrumbs">
        <ul class="breadcrumb">
              
                  <li id="projectVersion">Version: 15.0.0
                    </li>
              
              
                  <li id="publishDate" class="pull-right">Last Published: 2020-09-25</li>
            
                            </ul>
      </div>

            
      <div class="row-fluid">
        <div id="leftColumn" class="span2">
          <div class="well sidebar-nav">
              
                <ul class="nav nav-list">
                          
      <li>
  
                          <a href="../../index.html" title="Document Information">
          <span class="none"></span>
        Document Information</a>
            </li>
                                                                                                                                                            
      <li>
  
                          <a href="../../reflex-overview/index.html" title="ReFlex Overview">
          <span class="icon-chevron-right"></span>
        ReFlex Overview</a>
                  </li>
                
      <li>
  
                          <a href="../../installation-guide.html" title="Installation Guide">
          <span class="none"></span>
        Installation Guide</a>
            </li>
                                                                                                      
      <li>
  
                          <a href="../../update-guide/index.html" title="Update Guide">
          <span class="icon-chevron-right"></span>
        Update Guide</a>
                  </li>
                                                                                                                        
      <li>
  
                          <a href="../../use-cases/index.html" title="Use Cases">
          <span class="icon-chevron-right"></span>
        Use Cases</a>
                  </li>
                              <li class="nav-header">RAS documentation</li>
                              
      <li>
  
                          <a href="../../ras/overview.html" title="Overview">
          <span class="none"></span>
        Overview</a>
            </li>
                                                                                                      
      <li>
  
                          <a href="../../ras/configuration.html" title="Configuration">
          <span class="icon-chevron-right"></span>
        Configuration</a>
                  </li>
                                                                                                      
      <li>
  
                          <a href="../../ras/general-notes/index.html" title="General Notes">
          <span class="icon-chevron-right"></span>
        General Notes</a>
                  </li>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
      <li>
  
                          <a href="../../ras/rest-resources/index.html" title="REST API">
          <span class="icon-chevron-right"></span>
        REST API</a>
                  </li>
                                                                                                                                                                                                                                                      
      <li>
  
                          <a href="../../ras/usage-scenarios/index.html" title="Usage Scenarios">
          <span class="icon-chevron-right"></span>
        Usage Scenarios</a>
                  </li>
                                                                                                                                          
      <li>
  
                          <a href="../../ras/known-issues/index.html" title="Known Issues">
          <span class="icon-chevron-right"></span>
        Known Issues</a>
                  </li>
                              <li class="nav-header">CEP documentation</li>
                              
      <li>
  
                          <a href="../../cep/integration/integration_mechanism.html" title="Integration Mechanism">
          <span class="none"></span>
        Integration Mechanism</a>
            </li>
                                                                                                                                                                                          
      <li>
  
                          <a href="../../cep/integration/backend/index.html" title="Back End Integration">
          <span class="icon-chevron-right"></span>
        Back End Integration</a>
                  </li>
                                                                                                                                                                                                                        
      <li>
  
                          <a href="../../cep/integration/frontend/index.html" title="Front End Integration">
          <span class="icon-chevron-right"></span>
        Front End Integration</a>
                  </li>
                                                                                    
      <li>
  
                          <a href="../../cep/integration/features/index.html" title="Optional Features">
          <span class="icon-chevron-right"></span>
        Optional Features</a>
                  </li>
                                                                                                                              
      <li>
  
                          <a href="../../cep/integration/operations/index.html" title="Operations">
          <span class="icon-chevron-right"></span>
        Operations</a>
                  </li>
                
      <li>
  
                          <a href="../../cep/integration/known_issues.html" title="Known Issues">
          <span class="none"></span>
        Known Issues</a>
            </li>
                              <li class="nav-header">DCS documentation</li>
                              
      <li>
  
                          <a href="../../dcs/index.html" title="Overview">
          <span class="none"></span>
        Overview</a>
            </li>
                
      <li>
  
                          <a href="../../dcs/configuration.html" title="Configuration">
          <span class="none"></span>
        Configuration</a>
            </li>
                
      <li>
  
                          <a href="../../dcs/rest-api.html" title="REST API">
          <span class="none"></span>
        REST API</a>
            </li>
                                                                                                      
      <li>
  
                          <a href="../../dcs/template-config/template-configuration.html" title="Template Configuration">
          <span class="icon-chevron-right"></span>
        Template Configuration</a>
                  </li>
                
      <li>
  
                          <a href="../../dcs/known-issues.html" title="Known Issues">
          <span class="none"></span>
        Known Issues</a>
            </li>
                              <li class="nav-header">RSP documentation</li>
                                                                                                                                                                  
      <li>
  
                          <a href="../../rsp/integration/integration.html" title="Integration">
          <span class="icon-chevron-down"></span>
        Integration</a>
                    <ul class="nav nav-list">
                    
      <li>
  
                          <a href="../../rsp/integration/internal_external.html" title="Internal prepare vs external prepare">
          <span class="none"></span>
        Internal prepare vs external prepare</a>
            </li>
                    
      <li class="active">
  
            <a href="#"><span class="none"></span>Authentication, e-Signing and Logout</a>
          </li>
                    
      <li>
  
                          <a href="../../rsp/interfaces/output-interface.html" title="Output">
          <span class="none"></span>
        Output</a>
            </li>
                    
      <li>
  
                          <a href="../../rsp/integration/backend/housekeepingAPI.html" title="Housekeeping API">
          <span class="none"></span>
        Housekeeping API</a>
            </li>
                    
      <li>
  
                          <a href="../../rsp/integration/backend/persistence.html" title="Persistence">
          <span class="none"></span>
        Persistence</a>
            </li>
              </ul>
        </li>
                                                                                                                                                                                    
      <li>
  
                          <a href="../../rsp/configuration/configuration.html" title="Configuration">
          <span class="icon-chevron-right"></span>
        Configuration</a>
                  </li>
                              <li class="nav-header">MI documentation</li>
                              
      <li>
  
                          <a href="../../mi/installation/app-queue.html" title="AppQueue Installation">
          <span class="none"></span>
        AppQueue Installation</a>
            </li>
                                                                                    
      <li>
  
                          <a href="../../mi/index.html" title="Data export">
          <span class="icon-chevron-right"></span>
        Data export</a>
                  </li>
                              <li class="nav-header">3PS documentation</li>
                              
      <li>
  
                          <a href="../../tps/overview.html" title="Overview">
          <span class="none"></span>
        Overview</a>
            </li>
                                                                                                                        
      <li>
  
                          <a href="../../tps/configuration.html" title="Configuration">
          <span class="icon-chevron-right"></span>
        Configuration</a>
                  </li>
                                                                                    
      <li>
  
                          <a href="../../tps/api.html" title="REST API">
          <span class="icon-chevron-right"></span>
        REST API</a>
                  </li>
                              <li class="nav-header">UWB documentation</li>
                              
      <li>
  
                          <a href="../../uwb/index.html" title="Overview">
          <span class="none"></span>
        Overview</a>
            </li>
                                                                  
      <li>
  
                          <a href="../../uwb/installation/index.html" title="Installation">
          <span class="icon-chevron-right"></span>
        Installation</a>
                  </li>
                                                                                                                        
      <li>
  
                          <a href="../../uwb/configuration/application/index.html" title="Application Configuration">
          <span class="icon-chevron-right"></span>
        Application Configuration</a>
                  </li>
                                                                                                                                                                                    
      <li>
  
                          <a href="../../uwb/configuration/office/index.html" title="Office Configuration">
          <span class="icon-chevron-right"></span>
        Office Configuration</a>
                  </li>
                                                                                                                                                                                    
      <li>
  
                          <a href="../../uwb/features/index.html" title="Advanced Features">
          <span class="icon-chevron-right"></span>
        Advanced Features</a>
                  </li>
                                                                  
      <li>
  
                          <a href="../../uwb/operations/index.html" title="Operations">
          <span class="icon-chevron-right"></span>
        Operations</a>
                  </li>
                
      <li>
  
                          <a href="../../uwb/known_issues.html" title="Known Issues">
          <span class="none"></span>
        Known Issues</a>
            </li>
                              <li class="nav-header">MIGRATION documentation</li>
                              
      <li>
  
                          <a href="../../migration/index.html" title="User Guide">
          <span class="none"></span>
        User Guide</a>
            </li>
                              <li class="nav-header">Appendix</li>
                              
      <li>
  
                          <a href="../../glossary.html" title="Glossary">
          <span class="none"></span>
        Glossary</a>
            </li>
                
      <li>
  
                          <a href="../../component-versions.html" title="Component Versions">
          <span class="none"></span>
        Component Versions</a>
            </li>
                                                                                                                                          
      <li>
  
                          <a href="../../release-migration-notes.html" title="Release And Migration Notes">
          <span class="icon-chevron-right"></span>
        Release And Migration Notes</a>
                  </li>
                
      <li>
  
                          <a href="../../changelog.html" title="Changelog">
          <span class="none"></span>
        Changelog</a>
            </li>
            </ul>
              
                
          <hr />

           <div id="poweredBy">
                            <div class="clear"></div>
                            <div class="clear"></div>
                            <div class="clear"></div>
                            <div class="clear"></div>
                             <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy">
        <img class="builtBy" alt="Built by Maven" src="../../images/logos/maven-feather.png" />
      </a>
                  </div>
          </div>
        </div>
        
                
        <div id="bodyColumn"  class="span10" >
                                  
            <h1>Authentication Interface</h1><section>
<h2><a name="Interface"></a>Interface</h2>
<p>Authentication, signing and logout is generic in the RSP. This means that there is no specific implementation available to handle the authentication. There is only an interface available (see below) which needs an implementation that has to be provided at runtime. The RSP also provides an iframe on the authentication page in which the authentication UI should be presented.</p>

<div class="source">
<div class="source"><pre class="prettyprint">public interface Authentication {
    void setConfig(Map&lt;String, String&gt; config) throws Exception;
    
    String prepareLogin(Map&lt;String, String&gt; requestParams, String partnerId, String language) throws Exception;
    
    String getTrackingId(Map&lt;String, String&gt; requestParams, Map&lt;String, String&gt; requestHeaders) throws Exception;
    
    String getPartnerId(Map&lt;String, String&gt; requestParams) throws Exception;
    
    String prepareLogout(Map&lt;String, String&gt; requestParams) throws Exception;
    
    String prepareSign(Map&lt;String, String&gt; requestParams, String trackingId, String assessmentId, byte[] pdfDocument, String language) throws Exception;
    
    byte[] verifySign(Map&lt;String, String&gt; requestParams, String assessmentId, Map&lt;String, String&gt; requestHeaders) throws Exception;
}
</pre></div></div>

<p>The interface is provided by a JAR file to be included in <code>&lt;tomcat-home&gt;/lib</code> at runtime.</p>
<p>The implementation class has to implement the interface above and its fully qualified class name must be provided in <code>&lt;reflex-config&gt;/rsp/config.properties</code>.</p>

<div class="source">
<div class="source"><pre class="prettyprint">com.hannoverre.reflex.rsp.services.authentication.implementationClassName=com.hannoverre.reflex.rsp.authentication.AuthenticationImpl
</pre></div></div>

<p>Right after the implementation is loaded, the setConfig method is called which reads the <code>com.hannoverre.reflex.rsp.auth.implconfig</code> property from <code>&lt;reflex-config&gt;/rsp/config.properties</code>. This enables an integrator to make the implementation configurable. Note that this config is not a single value but rather a key/value map.</p>

<div class="source">
<div class="source"><pre class="prettyprint">com.hannoverre.reflex.rsp.auth.implconfig={key1:&quot;value1&quot;, key2:&quot;value2&quot;, ...}
</pre></div></div>

<p>The implementation class should be packaged in a JAR file and then be placed in <code>&lt;tomcat-home&gt;/lib</code> before starting tomcat.</p></section><section>
<h2><a name="Authentication"></a>Authentication</h2>
<p>The following methods are involved in the authentication:</p>
<ul>

<li>setConfig,</li>
<li>prepareLogin,</li>
<li>getTrackingId and</li>
<li>getPartnerId.</li>
</ul>
<p>The flow of the authentication process is presented below. Further details are listed below the picture.</p>
<p><img src="../images/rsp_authentication.png" alt="RSP Authentication" title="RSP Authentication" /></p>
<ol style="list-style-type: decimal">

<li>The user navigates to the authentication page. The normal scenario is that the user is continuing from the welcome page which triggers the authentication.</li>
<li>The authentication page consists of an iframe and the source of the iframe is retrieved from the backend using the implementation of prepareLogin.</li>
<li>Content is loaded in the iframe of the authentication page. This will be the UI of the authentication process. Note that this content is not in scope of the RSP. The same applies to its behaviour which could be whatever the integrator decides. The only requirement is that the user is redirected to the <code>/login/verify</code> endpoint in the end.</li>
<li><code>/login/verify</code> (verifyLogin) will call getTrackingId and getPartnerId of the authentication implementation which in turn can use external resources to resolve trackingId and/or partnerId.</li>
<li>The user context is then retrieved in the RSP based on the trackingId and partnerId. An error is thrown if no user context is found in the RSP.</li>
<li>Finally a JWT is created and returned as a cookie to the client. The JWT provides access to the user specific pages of the RSP. The user is redirected to the assessment information page.</li>
</ol><section>
<h3><a name="Interface_description"></a>Interface description</h3>
<p>Below are the interface methods along with more detailed descriptions.</p><section>
<h4><a name="setConfig"></a>setConfig</h4>
<p>Right after the implementation is loaded, the setConfig method is called which reads the <code>com.hannoverre.reflex.rsp.auth.implconfig</code> property from <code>&lt;reflex-config&gt;/rsp/config.properties</code>. This enables an integrator to make the implementation configurable. Note that this config is not a single value but rather a key/value map.</p>

<div class="source">
<div class="source"><pre class="prettyprint">com.hannoverre.reflex.rsp.auth.implconfig={key1:&quot;value1&quot;, key2:&quot;value2&quot;, ...}
</pre></div></div>
</section><section>
<h4><a name="prepareLogin"></a>prepareLogin</h4>
<p>This method is used to get the URL of the identity provider service. The implementation is expected to assemble the URL from e.g. configured values, language and partnerId.</p>
<p>A short example with code:</p>
<p>Let&#x2019;s say the config contains <code>com.hannoverre.reflex.rsp.auth.implconfig={loginLocation:&quot;https://some-eident-provider.com&quot;, serviceId:&quot;123456&quot;}</code> and &#x201c;en&#x201d; is set as the frontend language and the partnerId used is &#x201c;00000&#x201d;. Then the following implementation</p>

<div class="source">
<div class="source"><pre class="prettyprint">public String prepareLogin(Map&lt;String, String&gt; requestParams, String partnerId, String language) throws Exception {
    String langCode;
    switch (language) {
        case &quot;no&quot;:
        langCode = &quot;&amp;locale=nb_NO&quot;;
        break;
        case &quot;en&quot;:
        langCode = &quot;&amp;locale=en_GB&quot;;
        break;
        case &quot;da&quot;:
        langCode = &quot;&amp;locale=da_DK&quot;;
        break;
        case &quot;sv&quot;:
        langCode = &quot;&amp;locale=sv_SE&quot;;
        break;
        default:
        langCode = &quot;&quot;;
    }

    return config.get(&quot;loginLocation&quot;) + &quot;?service-id=&quot; + config.get(&quot;serviceId&quot;) + langCode + &quot;&amp;TARGET=&quot; + partnerId;
}
</pre></div></div>

<p>would assemble the URL <code>https://some-eident-provider.com?service-id=123456&amp;locale=en_GB&amp;TARGET=00000</code> which would be used to load the content of the authentication iframe.</p></section><section>
<h4><a name="getTrackingId_and_getPartnerId"></a>getTrackingId and getPartnerId</h4>
<p>The identity provider is expected to redirect the user&#x2019;s browser to <code>/login/verify</code> along with request parameters needed for verification. <code>/login/verify</code> will invoke <code>getTrackingId()</code> and <code>getPartnerId()</code> of the authentication implementation with the request parameters as input.</p>
<p>Below is an example implementation using Nets SAML authentication. <code>getTrackingId()</code> is making use of the SAML artifact provided from the identity provider to verify (assert) the authentication. This assertion is an external call to the identity provider using the SAML artifact. The trackingId is retrieved from the assertion response and is then returned.</p>

<div class="source">
<div class="source"><pre class="prettyprint">public String getTrackingId(Map&lt;String, String&gt; requestParams) throws Exception {
    String artifact = requestParams.get(&quot;SAMLart&quot;);
    Properties jsamleConfig = new Properties();
    jsamleConfig.put(&quot;assertionurl&quot;,
    config.get(&quot;assertionUrl&quot;));
    ...
    JSAMLE2 jsamle2 = new JSAMLE2(jsamleConfig);

    AssertionWrapper assertionWrapper = jsamle2.getAssertion(artifact);

    String authmethod = assertionWrapper.getAuthenticationStatement().getAuthenticationMethod();
    if (authmethod != null) {
        Map&lt;String, String&gt; assertionMap = assertionWrapper.getInfoItem();
        String trackingId = assertionMap.get(&quot;ssn&quot;);
        if (trackingId == null) {
            trackingId = assertionMap.get(&quot;DK_SSN&quot;);
        }
        if (trackingId == null) {
            trackingId = assertionMap.get(&quot;NO_SSN&quot;);
        }
        if (trackingId == null) {
            trackingId = assertionMap.get(&quot;SE_SSN&quot;);
        }
        if (trackingId == null) {
            throw new AssertionException(&quot;Could not find SSN&quot;);
        }

        return trackingId;
    } else {
        throw new Exception(&quot;AuthMethod was null in response!&quot;);
    }
}
</pre></div></div>

<p><code>getPartnerId()</code> also uses the request parameters passed from the identity provider. Below is an example in which the identity provider has passed along the TARGET parameter used in the auth iframe URL.</p>

<div class="source">
<div class="source"><pre class="prettyprint">public String getPartnerId(Map&lt;String, String&gt; requestParams) throws Exception {
    String partnerId = requestParams.get(&quot;TARGET&quot;);
    if (!partnerId.isEmpty()) {
        return partnerId;
    } else {
        throw new Exception(&quot;Missing partnerId in TARGET&quot;);
    }
}
</pre></div></div>

<p>After a successful verification of the user, <code>/login/verify</code> will create a JWT to be used in the RSP. The JWT will be returned as a cookie and headers are set to redirect the user to the assessment information page in the RSP.</p></section></section></section><section>
<h2><a name="E-Signing"></a>E-Signing</h2>
<p>The following methods are involved in the e-signing:</p>
<ul>

<li>setConfig,</li>
<li>prepareSign and</li>
<li>verifySign.</li>
</ul>
<p>The flow of the e-signing process is presented below. Further details are listed below the picture.</p>
<p><img src="../images/rsp_esign.png" alt="RSP e-signing" title="RSP e-signing" /></p>
<ol style="list-style-type: decimal">

<li>The user navigates to the signing page. The normal scenario is that the user i continuing from the review page.</li>
<li>The signing page consists of an iframe and the source of the iframe is retrieved from the backend using the implementation of prepareSign. Before the RSP core calls prepareSign, the sign PDF is created and passed to signPrepare. This is to enable a signing process in which a PDF is signed.</li>
<li>Content is loaded in the iframe of the signing page. This will be the UI of the signing process. Note that this content is not in scope of the RSP. The same applies to its behaviour which could be whatever the integrator decides. The only requirement is that the user is redirected to the <code>/sign/verify</code> endpoint in the end.</li>
<li><code>/sign/verify</code> (verifySign) will call verifySign of the implementation which in turn can use external resources to perform the actual verification. The signed PDF can be returned in this step.</li>
<li>Either the signed PDF or the external (customer) PDF is then stored in the user context.</li>
<li>Finally the user is redirected to the assessment result page.</li>
</ol></section><section>
<h2><a name="Logout"></a>Logout</h2>
<p>The following methods are involved in the logout:</p>
<ul>

<li>setConfig and</li>
<li>prepareLogout.</li>
</ul>
<p>Below is a description of logout process.</p>
<p><img src="../images/rsp_logout.png" alt="RSP logout" title="RSP logout" /></p>
<ol style="list-style-type: decimal">

<li>Whenever the user clicks the logout button, <code>/logout/prepare</code> is called.</li>
<li>prepareLogout of the authentication implementation is then called. prepareLogout should return the logout URL.</li>
<li>The logout URL is called.</li>
<li><code>/logout/verify</code> is called which sets cookie headers to remove the JWT created during authentication.</li>
</ol></section>
                  </div>
            </div>
          </div>

    <hr/>

    <footer>
            <div class="container-fluid">
                      <div class="row-fluid">
                                      <p >Copyright &copy;                   2020.
          All rights reserved.    
      </p>
                </div>

        
                </div>
    </footer>
        </body>
</html>
