<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia Site Renderer 1.9.2 at 2020-09-25 
 | Rendered using Apache Maven Fluido Skin 1.5
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="Date-Revision-yyyymmdd" content="20200925" />
    <meta http-equiv="Content-Language" content="en" />
    <title>ReFlex ReFlex Integrator's Handbook &#x2013; Authorization server installation</title>
    <link rel="stylesheet" href="../../css/apache-maven-fluido-1.5.min.css" />
    <link rel="stylesheet" href="../../css/site.css" />
    <link rel="stylesheet" href="../../css/print.css" media="print" />

      
    <script type="text/javascript" src="../../js/apache-maven-fluido-1.5.min.js"></script>

                      </head>
        <body class="topBarDisabled">
          
        
    
        <div class="container-fluid">
          <div id="banner">
        <div class="pull-left">
                                    <a href="https://www.hannover-re.com/" id="bannerLeft">
                                                                                                <img src="../../images/logo.svg"  alt="HannoverRe"/>
                </a>
                      </div>
        <div class="pull-right">                  <a href="https://www.hannover-re.com/" id="bannerRight">
                                                                                                <img src="../../images/hre-logo.svg"  alt="HannoverRe_log"/>
                </a>
      </div>
        <div class="clear"><hr/></div>
      </div>

      <div id="breadcrumbs">
        <ul class="breadcrumb">
              
                  <li id="projectVersion">Version: 15.0.0
                    </li>
              
              
                  <li id="publishDate" class="pull-right">Last Published: 2020-09-25</li>
            
                            </ul>
      </div>

            
      <div class="row-fluid">
        <div id="leftColumn" class="span2">
          <div class="well sidebar-nav">
              
                <ul class="nav nav-list">
                          
      <li>
  
                          <a href="../../index.html" title="Document Information">
          <span class="none"></span>
        Document Information</a>
            </li>
                                                                                                                                                            
      <li>
  
                          <a href="../../reflex-overview/index.html" title="ReFlex Overview">
          <span class="icon-chevron-right"></span>
        ReFlex Overview</a>
                  </li>
                
      <li>
  
                          <a href="../../installation-guide.html" title="Installation Guide">
          <span class="none"></span>
        Installation Guide</a>
            </li>
                                                                                                      
      <li>
  
                          <a href="../../update-guide/index.html" title="Update Guide">
          <span class="icon-chevron-right"></span>
        Update Guide</a>
                  </li>
                                                                                                                        
      <li>
  
                          <a href="../../use-cases/index.html" title="Use Cases">
          <span class="icon-chevron-right"></span>
        Use Cases</a>
                  </li>
                              <li class="nav-header">RAS documentation</li>
                              
      <li>
  
                          <a href="../../ras/overview.html" title="Overview">
          <span class="none"></span>
        Overview</a>
            </li>
                                                                                                      
      <li>
  
                          <a href="../../ras/configuration.html" title="Configuration">
          <span class="icon-chevron-right"></span>
        Configuration</a>
                  </li>
                                                                                                      
      <li>
  
                          <a href="../../ras/general-notes/index.html" title="General Notes">
          <span class="icon-chevron-right"></span>
        General Notes</a>
                  </li>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
      <li>
  
                          <a href="../../ras/rest-resources/index.html" title="REST API">
          <span class="icon-chevron-right"></span>
        REST API</a>
                  </li>
                                                                                                                                                                                                                                                      
      <li>
  
                          <a href="../../ras/usage-scenarios/index.html" title="Usage Scenarios">
          <span class="icon-chevron-right"></span>
        Usage Scenarios</a>
                  </li>
                                                                                                                                          
      <li>
  
                          <a href="../../ras/known-issues/index.html" title="Known Issues">
          <span class="icon-chevron-right"></span>
        Known Issues</a>
                  </li>
                              <li class="nav-header">CEP documentation</li>
                              
      <li>
  
                          <a href="../../cep/integration/integration_mechanism.html" title="Integration Mechanism">
          <span class="none"></span>
        Integration Mechanism</a>
            </li>
                                                                                                                                                                                          
      <li>
  
                          <a href="../../cep/integration/backend/index.html" title="Back End Integration">
          <span class="icon-chevron-right"></span>
        Back End Integration</a>
                  </li>
                                                                                                                                                                                                                        
      <li>
  
                          <a href="../../cep/integration/frontend/index.html" title="Front End Integration">
          <span class="icon-chevron-right"></span>
        Front End Integration</a>
                  </li>
                                                                                    
      <li>
  
                          <a href="../../cep/integration/features/index.html" title="Optional Features">
          <span class="icon-chevron-right"></span>
        Optional Features</a>
                  </li>
                                                                                                                              
      <li>
  
                          <a href="../../cep/integration/operations/index.html" title="Operations">
          <span class="icon-chevron-right"></span>
        Operations</a>
                  </li>
                
      <li>
  
                          <a href="../../cep/integration/known_issues.html" title="Known Issues">
          <span class="none"></span>
        Known Issues</a>
            </li>
                              <li class="nav-header">DCS documentation</li>
                              
      <li>
  
                          <a href="../../dcs/index.html" title="Overview">
          <span class="none"></span>
        Overview</a>
            </li>
                
      <li>
  
                          <a href="../../dcs/configuration.html" title="Configuration">
          <span class="none"></span>
        Configuration</a>
            </li>
                
      <li>
  
                          <a href="../../dcs/rest-api.html" title="REST API">
          <span class="none"></span>
        REST API</a>
            </li>
                                                                                                      
      <li>
  
                          <a href="../../dcs/template-config/template-configuration.html" title="Template Configuration">
          <span class="icon-chevron-right"></span>
        Template Configuration</a>
                  </li>
                
      <li>
  
                          <a href="../../dcs/known-issues.html" title="Known Issues">
          <span class="none"></span>
        Known Issues</a>
            </li>
                              <li class="nav-header">RSP documentation</li>
                                                                                                                                                        
      <li>
  
                          <a href="../../rsp/integration/integration.html" title="Integration">
          <span class="icon-chevron-right"></span>
        Integration</a>
                  </li>
                                                                                                                                                                                    
      <li>
  
                          <a href="../../rsp/configuration/configuration.html" title="Configuration">
          <span class="icon-chevron-right"></span>
        Configuration</a>
                  </li>
                              <li class="nav-header">MI documentation</li>
                              
      <li>
  
                          <a href="../../mi/installation/app-queue.html" title="AppQueue Installation">
          <span class="none"></span>
        AppQueue Installation</a>
            </li>
                                                                                    
      <li>
  
                          <a href="../../mi/index.html" title="Data export">
          <span class="icon-chevron-right"></span>
        Data export</a>
                  </li>
                              <li class="nav-header">3PS documentation</li>
                              
      <li>
  
                          <a href="../../tps/overview.html" title="Overview">
          <span class="none"></span>
        Overview</a>
            </li>
                                                                                                                        
      <li>
  
                          <a href="../../tps/configuration.html" title="Configuration">
          <span class="icon-chevron-right"></span>
        Configuration</a>
                  </li>
                                                                                    
      <li>
  
                          <a href="../../tps/api.html" title="REST API">
          <span class="icon-chevron-right"></span>
        REST API</a>
                  </li>
                              <li class="nav-header">UWB documentation</li>
                              
      <li>
  
                          <a href="../../uwb/index.html" title="Overview">
          <span class="none"></span>
        Overview</a>
            </li>
                                                                            
      <li>
  
                          <a href="../../uwb/installation/index.html" title="Installation">
          <span class="icon-chevron-down"></span>
        Installation</a>
                    <ul class="nav nav-list">
                    
      <li class="active">
  
            <a href="#"><span class="none"></span>Authorization Server</a>
          </li>
              </ul>
        </li>
                                                                                                                        
      <li>
  
                          <a href="../../uwb/configuration/application/index.html" title="Application Configuration">
          <span class="icon-chevron-right"></span>
        Application Configuration</a>
                  </li>
                                                                                                                                                                                    
      <li>
  
                          <a href="../../uwb/configuration/office/index.html" title="Office Configuration">
          <span class="icon-chevron-right"></span>
        Office Configuration</a>
                  </li>
                                                                                                                                                                                    
      <li>
  
                          <a href="../../uwb/features/index.html" title="Advanced Features">
          <span class="icon-chevron-right"></span>
        Advanced Features</a>
                  </li>
                                                                  
      <li>
  
                          <a href="../../uwb/operations/index.html" title="Operations">
          <span class="icon-chevron-right"></span>
        Operations</a>
                  </li>
                
      <li>
  
                          <a href="../../uwb/known_issues.html" title="Known Issues">
          <span class="none"></span>
        Known Issues</a>
            </li>
                              <li class="nav-header">MIGRATION documentation</li>
                              
      <li>
  
                          <a href="../../migration/index.html" title="User Guide">
          <span class="none"></span>
        User Guide</a>
            </li>
                              <li class="nav-header">Appendix</li>
                              
      <li>
  
                          <a href="../../glossary.html" title="Glossary">
          <span class="none"></span>
        Glossary</a>
            </li>
                
      <li>
  
                          <a href="../../component-versions.html" title="Component Versions">
          <span class="none"></span>
        Component Versions</a>
            </li>
                                                                                                                                          
      <li>
  
                          <a href="../../release-migration-notes.html" title="Release And Migration Notes">
          <span class="icon-chevron-right"></span>
        Release And Migration Notes</a>
                  </li>
                
      <li>
  
                          <a href="../../changelog.html" title="Changelog">
          <span class="none"></span>
        Changelog</a>
            </li>
            </ul>
              
                
          <hr />

           <div id="poweredBy">
                            <div class="clear"></div>
                            <div class="clear"></div>
                            <div class="clear"></div>
                            <div class="clear"></div>
                             <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy">
        <img class="builtBy" alt="Built by Maven" src="../../images/logos/maven-feather.png" />
      </a>
                  </div>
          </div>
        </div>
        
                
        <div id="bodyColumn"  class="span10" >
                                  
            <h1>Authorization server installation</h1>
<p>The UWB delegates identity and access management to an external system. The IAM-System recommended by ReFlex is <a class="externalLink" href="https://www.keycloak.org/"><b>Keycloak</b></a>, but the UWB will also work with other authorization servers that meet the following requirements:</p>
<ul>

<li>MUST support OAuth2 <i>Access Code Flow with PKCE</i> and provide refresh tokens for public clients.</li>
<li>MUST support OAuth2 <i>Client Credentials Flow</i> (only if external systems should be able to call the UWB Rest API, e.g. the <a href="../features/import-api-configuration.html">Import API</a>).</li>
<li>MUST provide an <a class="externalLink" href="https://tools.ietf.org/html/rfc8414#section-3">OAuth 2.0 Authorization Server Metadata Endpoint</a> OR an <a class="externalLink" href="https://openid.net/specs/openid-connect-discovery-1_0.html#ProviderConfig">OpenID Connect 1.0 Provider Configuration Endpoint</a> that relate to a <code>jwks_url</code> accessible by the UWB-Server.</li>
<li>Issued access tokens MUST be self-contained <i>Json Web Tokens (JWTs)</i> that can be validated against the Authorization Servers <i>JSON Web Key Store (JWKS)</i>.</li>
<li>MUST provide an <a class="externalLink" href="https://openid.net/specs/openid-connect-core-1_0.html#UserInfo">OpenID Connect Core 1.0 UserInfo Endpoint</a>. This endpoint must provide the following claims:
<ul>

<li><code>preferredUsername</code>, <code>email</code>, <code>name</code> (mandatory)</li>
<li><code>organizationalUnitName</code>, <code>location</code> with the semantic from an LDAP OrganizationalPerson (RFC-4519) fields <code>uo</code> and <code>l</code> (mandatory only if the sanction/watchlist screening feature is enabled)</li>
</ul>
</li>
</ul>
<p>The UWB may be used by users (natural persons) or by other external systems. Users interact with the UWB using the web user interface while external systems will interact with the UWB REST API. Having an external system that acts on behalf of an external UWB user (and inherits their roles) is currently not supported.</p>
<p>If a user representing a natural person opens the UWB web application, they will be redirected to the authorization servers login page. Once they have been authorized (using their username and password or some other form of credentials), they will be redirected back to the UWB web application. The access token is stored by the UWB web application in its session storage.</p>
<p>A technical user representing an external system must use the client credentials flow to obtain an access token from the authorization server. After obtaining an access token, the external system can call the UWB REST API, providing the access token as authorization header. Example:</p>

<div class="source">
<div class="source"><pre class="prettyprint">$ curl https://uwb.demo/api/actuator/health -H 'Authorization: Bearer eyJhbGciOiJ...'
</pre></div></div>
<section>
<h2><a name="Access_token_requirements"></a>Access token requirements</h2>
<p>The access token is provided in the Authentication HTTP header as JWT Bearer token.</p>
<p>The issued access token must contain at least the following claims:</p>

<div class="source">
<div class="source"><pre class="prettyprint">{
  &quot;jti&quot;: &quot;...&quot;,
  &quot;exp&quot;: 1,
  &quot;nbf&quot;: 1,
  &quot;iat&quot;: 1,
  &quot;iss&quot;: &quot;issuerId&quot;,
  &quot;sub&quot;: &quot;subjectId&quot;,
  &quot;typ&quot;: &quot;Bearer&quot;,
  &quot;resource_access&quot;: {
    &quot;uwb&quot;: {
      &quot;roles&quot;: [
        &quot;USER&quot;,
        ...
      ]
    }
  }
}
</pre></div></div>

<p>Apart from JWT standard fields, the relevant section for UWB access control is the section <code>resource_access.uwb.roles</code>. This section must contain all UWB roles the user is assigned to. Please refer to the <a href="../configuration/application/permission-configuration.html">Permission Configuration</a> for details.</p>
<p>If the token contains an <code>aud</code>-claim (referring to the tokens intended audience), it must either represent the string <code>&quot;uwb&quot;</code> or an array with the string <code>&quot;uwb&quot;</code> as an element.</p>
<p>If the token issued to a logged-in user contains the <code>azp</code>-claim (referring to the authorized party), it must contain the string <code>&quot;uwb-ui&quot;</code>.</p>
<blockquote>

<p>Note: the <code>resources_access</code> entry &#x201c;uwb&#x201d; relates to the default OAuth2 clientId for UWB. When the clientId is changed, the <code>resources_access</code> claim must be changed accordingly.</p>
</blockquote></section><section>
<h2><a name="Keycloak_configuration"></a>Keycloak configuration</h2>
<p>Installing and hardening Keycloak is beyond the scope of this manual. Please refer to the official <a class="externalLink" href="https://www.keycloak.org/documentation.html">Keycloak documentation</a> for installation and configuration instructions. The minimal Keycloak version required by UWB is Keycloak 9.0.3.</p><section>
<h3><a name="Keycloak_UWB_realm_configuration"></a>Keycloak UWB realm configuration</h3>
<p>This documentation ships with a minimal keycloak realm configuration for UWB that is sufficient to provide a user access to all UWB offices and the administration console. It can be used as a starting point for further integration work.</p>
<p><b>Prerequisites:</b></p>
<ul>

<li>You have installed keycloak and it is exposed on a user-reachable domain via HTTPS</li>
<li>You have installed the UWB and it is exposed on a user-reachable domain via HTTPS</li>
</ul>
<p><b>Configuration steps:</b></p>
<p><i>Note:</i> Associated URLs configured in Keycloak and in the UWB configuration file must be kept synchronized and are <b>case-sensitive</b>.</p>
<ol style="list-style-type: decimal">

<li>To get started, please open the Keycloak administration interface in the master realm.</li>
<li>Then choose to <i>Add Realm</i>, save this <a href="./realm.json">realm.json</a> file to your desktop and select it as <i>Import</i> file. Choose a meaningful name for your realm and choose <i>Create</i>.</li>
<li>Choose the created realm and choose <i>Configure -&gt; Clients -&gt; uwb-ui -&gt; Settings</i>
<ul>

<li>Change the <i>Root URL</i> to the actual user visible URL of your UWB-Installation.</li>
<li>Change the prefix of the <i>Valid Redirect URIs</i> as well. You may provide multiple URIs here.</li>
<li>Change <i>Admin URL</i> and <i>Web Origins</i> as well to the same value as the <i>Root URL</i>.</li>
<li>Save your changes.</li>
</ul>
</li>
<li>Click <i>Realm Settings -&gt; General -&gt; Endpoints -&gt; OpenID Endpoint Configuration</i> and copy the URL from the issuer property of the displayed JSON document. This URL has to be configured in the UWB configuration file <code>application.properties</code> as <code>spring.security.oauth2.resourceserver.jwt.issuer-uri</code>.</li>
<li>You can now log into the UWB with the username <b>reflex_admin</b> and the Password <b>password</b>. Please make sure to either disable this user or change its password before you go into production.</li>
</ol></section></section>
                  </div>
            </div>
          </div>

    <hr/>

    <footer>
            <div class="container-fluid">
                      <div class="row-fluid">
                                      <p >Copyright &copy;                   2020.
          All rights reserved.    
      </p>
                </div>

        
                </div>
    </footer>
        </body>
</html>
